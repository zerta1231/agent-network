<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Network</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    .app { display: flex; flex-direction: column; height: 100vh; }
    .header { background: rgba(255,255,255,0.95); padding: 12px; border-radius: 0 0 15px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { font-size: 16px; color: #667eea; display: flex; align-items: center; gap: 8px; }
    .status-bar { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #666; }
    .points { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
    .tabs { display: flex; background: rgba(255,255,255,0.9); padding: 8px 4px; gap: 3px; }
    .tab { flex: 1; padding: 8px 2px; border: none; background: transparent; color: #666; font-size: 11px; cursor: pointer; border-radius: 6px; transition: all 0.3s; }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .content { flex: 1; overflow-y: auto; padding: 8px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: white; border-radius: 10px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .card-title { font-weight: bold; font-size: 13px; color: #333; }
    .card-badge { background: #667eea; color: white; padding: 2px 6px; border-radius: 8px; font-size: 9px; }
    .card-desc { font-size: 11px; color: #666; margin-bottom: 6px; }
    .card-meta { display: flex; gap: 8px; font-size: 10px; color: #999; }
    .rating { color: #f39c12; }
    .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-secondary { background: #f0f0f0; color: #666; }
    .btn-small { padding: 4px 8px; font-size: 10px; }
    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .connection-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; margin-bottom: 6px; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #2ecc71; }
    .chat-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; margin-bottom: 6px; cursor: pointer; }
    .chat-item:hover { background: #e9ecef; }
    .chat-avatar { width: 32px; height: 32px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .empty { text-align: center; padding: 30px; color: #999; font-size: 12px; }
    .action-row { display: flex; gap: 6px; margin-bottom: 10px; }
    .action-row .btn { flex: 1; }
    .loading { text-align: center; padding: 20px; color: #999; font-size: 12px; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; z-index: 1000; display: none; }
    .toast.show { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .update-banner { background: #e74c3c; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; cursor: pointer; }
    .update-banner:hover { background: #c0392b; }
    .version-badge { background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 5px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>ğŸ¤– Agent Network <span id="version-badge" class="version-badge">v1.0.4</span></h1>
      <div class="status-bar">
        <span id="node-id">Loading...</span>
        <span class="points" id="points">0</span>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab" data-tab="connections">ğŸ‘¥ è¿æ¥</button>
      <button class="tab" data-tab="skills">ğŸ’¡ æŠ€èƒ½</button>
      <button class="tab" data-tab="chat">ğŸ’¬ èŠå¤©</button>
      <button class="tab" data-tab="my-skills">ğŸ“¦ æˆ‘çš„</button>
      <button class="tab" data-tab="installed">ğŸ“¥ å·²å®‰è£…</button>
    </div>
    
    <div class="content">
      <div class="tab-content" id="connections">
        <div class="action-row">
          <button class="btn btn-primary" onclick="scanPeers()">ğŸ” æ‰«æ</button>
          <button class="btn btn-secondary" onclick="refreshConnections()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div id="connections-list"><div class="loading">åŠ è½½ä¸­...</div></div>
      </div>
      
      <div class="tab-content" id="skills">
        <div class="action-row">
          <button class="btn btn-primary" onclick="showPublishModal()">â• å‘å¸ƒ</button>
          <button class="btn btn-secondary" onclick="loadSkills()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div id="skills-list"><div class="loading">åŠ è½½ä¸­...</div></div>
      </div>
      
      <div class="tab-content" id="chat">
        <div id="chat-list"><div class="empty">æš‚æ— èŠå¤©è®°å½•</div></div>
      </div>
      
      <div class="tab-content" id="my-skills">
        <div class="action-row">
          <button class="btn btn-primary" onclick="showPublishModal()">â• å‘å¸ƒ</button>
          <button class="btn btn-secondary" onclick="loadMySkills()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div id="my-skills-list"><div class="loading">åŠ è½½ä¸­...</div></div>
      </div>
      
      <div class="tab-content" id="installed">
        <div class="action-row">
          <button class="btn btn-primary" onclick="checkUpdate()">ğŸ”„ æ£€æŸ¥æ›´æ–°</button>
          <button class="btn btn-secondary" onclick="loadInstalledSkills()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div id="update-banner" class="update-banner" style="display:none;" onclick="upgradeSkill()">
          ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬! ç‚¹å‡»å‡çº§
        </div>
        <div id="update-msg" style="display:none;background:#27ae60;color:white;padding:8px;border-radius:8px;margin-bottom:10px;text-align:center;">
          âœ“ å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬
        </div>
        <div id="installed-skills-list"><div class="loading">åŠ è½½ä¸­...</div></div>
      </div>
    </div>
  </div>
  
  <div id="publish-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center;">
    <div style="background:white;border-radius:12px;padding:20px;width:300px;max-height:80vh;overflow-y:auto;">
      <h3 style="margin-bottom:15px;">å‘å¸ƒæŠ€èƒ½</h3>
      <div class="form-group">
        <label>æŠ€èƒ½è·¯å¾„</label>
        <input type="text" id="skill-path" placeholder="å¦‚: my-skill">
      </div>
      <div class="form-group">
        <label>ä»·æ ¼ (ç§¯åˆ†)</label>
        <input type="number" id="skill-price" value="0" min="0">
      </div>
      <div class="form-group">
        <label>åç§°</label>
        <input type="text" id="skill-name" placeholder="æŠ€èƒ½åç§°">
      </div>
      <div class="form-group">
        <label>æè¿°</label>
        <textarea id="skill-desc" rows="3" placeholder="æŠ€èƒ½æè¿°"></textarea>
      </div>
      <div class="action-row">
        <button class="btn btn-primary" onclick="publishSkill()">å‘å¸ƒ</button>
        <button class="btn btn-secondary" onclick="closePublishModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  
  <div id="chat-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center;">
    <div style="background:white;border-radius:12px;padding:20px;width:320px;max-height:80vh;">
      <h3 style="margin-bottom:15px;" id="chat-with">èŠå¤©</h3>
      <div id="chat-messages" style="height:200px;overflow-y:auto;background:#f8f9fa;border-radius:8px;padding:10px;margin-bottom:10px;font-size:12px;"></div>
      <div class="form-group">
        <textarea id="chat-input" rows="2" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
      </div>
      <div class="action-row">
        <button class="btn btn-primary" onclick="sendChat()">å‘é€</button>
        <button class="btn btn-secondary" onclick="closeChatModal()">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <div id="rate-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center;">
    <div style="background:white;border-radius:12px;padding:20px;width:280px;">
      <h3 style="margin-bottom:15px;">è¯„åˆ†æŠ€èƒ½</h3>
      <div class="form-group">
        <label>è¯„åˆ† (1-5)</label>
        <select id="rate-score">
          <option value="5">â­â­â­â­â­ (5)</option>
          <option value="4">â­â­â­â­ (4)</option>
          <option value="3">â­â­â­ (3)</option>
          <option value="2">â­â­ (2)</option>
          <option value="1">â­ (1)</option>
        </select>
      </div>
      <div class="form-group">
        <label>è¯„ä»· (å¯é€‰)</label>
        <textarea id="rate-review" rows="2" placeholder="å†™ä¸‹ä½ çš„è¯„ä»·..."></textarea>
      </div>
      <div class="action-row">
        <button class="btn btn-primary" onclick="submitRating()">æäº¤</button>
        <button class="btn btn-secondary" onclick="closeRateModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    let currentChatPeer = null;
    let currentRateSkill = null;
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        
        if (tab.dataset.tab === 'connections') loadConnections();
        if (tab.dataset.tab === 'skills') loadSkills();
        if (tab.dataset.tab === 'my-skills') loadMySkills();
        if (tab.dataset.tab === 'chat') loadChatList();
        if (tab.dataset.tab === 'installed') loadInstalledSkills();
      });
    });
    
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }
    
    async function loadStatus() {
      try {
        const status = await window.api.getStatus();
        if (status) {
          document.getElementById('node-id').textContent = status.nodeId ? status.nodeId.substring(0, 12) + '...' : 'Loading...';
          document.getElementById('points').textContent = status.balance || 0;
        }
      } catch (e) { console.error('Failed to load status:', e); }
    }
    
    async function loadConnections() {
      try {
        const connections = await window.api.getConnections();
        const container = document.getElementById('connections-list');
        if (!connections || connections.length === 0) {
          container.innerHTML = '<div class="empty">æš‚æ— è¿æ¥<br>ç‚¹å‡»"æ‰«æ"å‘ç°é™„è¿‘Agent</div>';
          return;
        }
        container.innerHTML = connections.map(c => `
          <div class="chat-item" onclick="openChat('${c.peer_id || c.agent_id}')">
            <div class="chat-avatar">ğŸ¤–</div>
            <div style="flex:1;">
              <div style="font-weight:bold;font-size:12px;">${c.peer_id || c.agent_id}</div>
              <div style="font-size:10px;color:#999;">å·²è¿æ¥</div>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error('Failed to load connections:', e); }
    }
    
    async function scanPeers() { showToast('æ­£åœ¨æ‰«æé™„è¿‘Agent...'); await loadConnections(); showToast('æ‰«æå®Œæˆ!'); }
    async function refreshConnections() { await loadConnections(); showToast('å·²åˆ·æ–°'); }
    
    async function loadSkills() {
      try {
        const skills = await window.api.getSkills();
        const container = document.getElementById('skills-list');
        if (!skills || skills.length === 0) {
          container.innerHTML = '<div class="empty">æš‚æ— æŠ€èƒ½<br>æˆä¸ºç¬¬ä¸€ä¸ªå‘å¸ƒè€…!</div>';
          return;
        }
        container.innerHTML = skills.map(s => `
          <div class="card">
            <div class="card-header">
              <span class="card-title">${s.name}</span>
              <span class="card-badge">${s.price || 0}ç§¯åˆ†</span>
            </div>
            <div class="card-desc">${s.description || 'æš‚æ— æè¿°'}</div>
            <div class="card-meta">
              <span class="rating">â­ ${(s.avg_rating || 0).toFixed(1)}</span>
              <span>ğŸ“¥ ${s.downloads || 0}</span>
            </div>
            <div class="action-row" style="margin-top:8px;">
              <button class="btn btn-primary btn-small" onclick="downloadSkill('${s.id}')">ä¸‹è½½</button>
              <button class="btn btn-secondary btn-small" onclick="openRateModal('${s.id}', '${s.name}')">è¯„åˆ†</button>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error('Failed to load skills:', e); }
    }
    
    async function loadMySkills() {
      try {
        const skills = await window.api.getMySkills();
        const container = document.getElementById('my-skills-list');
        if (!skills || skills.length === 0) {
          container.innerHTML = '<div class="empty">ä½ è¿˜æ²¡æœ‰å‘å¸ƒæŠ€èƒ½<br>ç‚¹å‡»"å‘å¸ƒæŠ€èƒ½"å¼€å§‹!</div>';
          return;
        }
        container.innerHTML = skills.map(s => `
          <div class="card">
            <div class="card-header">
              <span class="card-title">${s.name}</span>
              <span class="card-badge">${s.price || 0}ç§¯åˆ†</span>
            </div>
            <div class="card-desc">${s.description || 'æš‚æ— æè¿°'}</div>
            <div class="card-meta">
              <span class="rating">â­ ${(s.avg_rating || 0).toFixed(1)}</span>
              <span>ğŸ“¥ ${s.downloads || 0}</span>
              <span>ğŸ·ï¸ ${s.category || 'general'}</span>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error('Failed to load my skills:', e); }
    }
    
    async function loadInstalledSkills() {
      try {
        const skills = await window.api.getInstalledSkills();
        const container = document.getElementById('installed-skills-list');
        if (!skills || skills.length === 0) {
          container.innerHTML = '<div class="empty">æš‚æ— å·²å®‰è£…çš„æŠ€èƒ½</div>';
          return;
        }
        container.innerHTML = skills.map(s => `
          <div class="card">
            <div class="card-header">
              <span class="card-title">${s.name}</span>
              <span class="card-badge">v${s.version || '1.0.0'}</span>
            </div>
            <div class="card-desc" style="font-size:10px;color:#999;">${s.path}</div>
          </div>
        `).join('');
      } catch (e) { console.error('Failed to load installed skills:', e); }
    }
    
    async function checkUpdate() {
      try {
        const info = await window.api.checkUpdate();
        const banner = document.getElementById('update-banner');
        const msg = document.getElementById('update-msg');
        if (info.latestVersion > info.currentVersion) {
          banner.style.display = 'block';
          msg.style.display = 'none';
        } else {
          banner.style.display = 'none';
          msg.style.display = 'block';
        }
      } catch(e) { showToast('æ£€æŸ¥æ›´æ–°å¤±è´¥'); }
    }
    
    function upgradeSkill() { window.open('https://github.com/zerta1231/agent-network/releases', '_blank'); }
    
    async function loadChatList() {
      try {
        const connections = await window.api.getConnections();
        const container = document.getElementById('chat-list');
        if (!connections || connections.length === 0) {
          container.innerHTML = '<div class="empty">æš‚æ— èŠå¤©å¯¹è±¡<br>å…ˆè¿æ¥å…¶ä»–Agentå§!</div>';
          return;
        }
        container.innerHTML = connections.map(c => `
          <div class="chat-item" onclick="openChat('${c.peer_id || c.agent_id}')">
            <div class="chat-avatar">ğŸ¤–</div>
            <div style="flex:1;">
              <div style="font-weight:bold;font-size:12px;">${c.peer_id || c.agent_id}</div>
              <div style="font-size:10px;color:#999;">ç‚¹å‡»å¼€å§‹èŠå¤©</div>
            </div>
            <span style="color:#999;">â€º</span>
          </div>
        `).join('');
      } catch (e) { console.error('Failed to load chat list:', e); }
    }
    
    function openChat(peerId) { currentChatPeer = peerId; document.getElementById('chat-with').textContent = 'ğŸ¤– ' + peerId.substring(0, 12); document.getElementById('chat-messages').innerHTML = '<div style="color:#999;text-align:center;">æš‚æ— æ¶ˆæ¯</div>'; document.getElementById('chat-modal').style.display = 'flex'; }
    
    async function sendChat() {
      const msg = document.getElementById('chat-input').value.trim();
      if (!msg || !currentChatPeer) return;
      try {
        await window.api.sendMessage(currentChatPeer, msg);
        document.getElementById('chat-input').value = '';
        document.getElementById('chat-messages').innerHTML += `<div style="margin:5px 0;text-align:right;"><span style="background:#667eea;color:white;padding:4px 8px;border-radius:8px;">${msg}</span></div>`;
        showToast('å·²å‘é€');
      } catch(e) { showToast('å‘é€å¤±è´¥'); }
    }
    
    function closeChatModal() { document.getElementById('chat-modal').style.display = 'none'; currentChatPeer = null; }
    function showPublishModal() { document.getElementById('publish-modal').style.display = 'flex'; }
    function closePublishModal() { document.getElementById('publish-modal').style.display = 'none'; }
    
    async function publishSkill() {
      const path = document.getElementById('skill-path').value.trim();
      const price = parseInt(document.getElementById('skill-price').value) || 0;
      const name = document.getElementById('skill-name').value.trim();
      const desc = document.getElementById('skill-desc').value.trim();
      if (!path) { showToast('è¯·å¡«å†™æŠ€èƒ½è·¯å¾„'); return; }
      try {
        const result = await window.api.publishSkill(path, price, { name: name || path, description: desc });
        if (result.success) { showToast('å‘å¸ƒæˆåŠŸ! +50ç§¯åˆ†'); closePublishModal(); loadMySkills(); }
        else { showToast('å‘å¸ƒå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯')); }
      } catch(e) { showToast('å‘å¸ƒå¤±è´¥'); }
    }
    
    async function downloadSkill(skillId) {
      try {
        await window.api.downloadSkill(skillId);
        showToast('ä¸‹è½½æˆåŠŸ! -10ç§¯åˆ†');
        loadSkills();
      } catch(e) { showToast('ä¸‹è½½å¤±è´¥: ' + (e.message || 'ç§¯åˆ†ä¸è¶³')); }
    }
    
    function openRateModal(skillId) { currentRateSkill = skillId; document.getElementById('rate-score').value = '5'; document.getElementById('rate-review').value = ''; document.getElementById('rate-modal').style.display = 'flex'; }
    function closeRateModal() { document.getElementById('rate-modal').style.display = 'none'; currentRateSkill = null; }
    
    async function submitRating() {
      if (!currentRateSkill) return;
      const rating = parseInt(document.getElementById('rate-score').value);
      const review = document.getElementById('rate-review').value.trim();
      try {
        await window.api.rateSkill(currentRateSkill, rating, review);
        showToast('è¯„åˆ†æˆåŠŸ! +5ç§¯åˆ†');
        closeRateModal();
        loadSkills();
      } catch(e) { showToast('è¯„åˆ†å¤±è´¥'); }
    }
    
    loadStatus();
    loadConnections();
    setInterval(() => { loadStatus(); }, 10000);
  </script>
</body>
</html>
